

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>eucaops.ec2ops &mdash; Eutester 0.0.4 documentation</title>
    
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/theme_extras.js"></script>
    <link rel="top" title="Eutester 0.0.4 documentation" href="../../index.html" />
    <link rel="up" title="eucaops" href="../eucaops.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../index.html">
          <span>Eutester 0.0.4 documentation</span></a></h1>
        <h2 class="heading"><span>eucaops.ec2ops</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for eucaops.ec2ops</h1><div class="highlight"><pre>
<span class="c"># Software License Agreement (BSD License)</span>
<span class="c">#</span>
<span class="c"># Copyright (c) 2009-2011, Eucalyptus Systems, Inc.</span>
<span class="c"># All rights reserved.</span>
<span class="c">#</span>
<span class="c"># Redistribution and use of this software in source and binary forms, with or</span>
<span class="c"># without modification, are permitted provided that the following conditions</span>
<span class="c"># are met:</span>
<span class="c">#</span>
<span class="c">#   Redistributions of source code must retain the above</span>
<span class="c">#   copyright notice, this list of conditions and the</span>
<span class="c">#   following disclaimer.</span>
<span class="c">#</span>
<span class="c">#   Redistributions in binary form must reproduce the above</span>
<span class="c">#   copyright notice, this list of conditions and the</span>
<span class="c">#   following disclaimer in the documentation and/or other</span>
<span class="c">#   materials provided with the distribution.</span>
<span class="c">#</span>
<span class="c"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="c"># ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<span class="c"># LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="c"># CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="c"># SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="c"># INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="c"># CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="c"># ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="c"># POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c">#</span>
<span class="c"># Author: vic.iglesias@eucalyptus.com</span>


<span class="kn">from</span> <span class="nn">eutester</span> <span class="kn">import</span> <span class="n">Eutester</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">boto.ec2.image</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">boto.ec2.blockdevicemapping</span> <span class="kn">import</span> <span class="n">BlockDeviceMapping</span><span class="p">,</span> <span class="n">BlockDeviceType</span>
<span class="kn">from</span> <span class="nn">boto.exception</span> <span class="kn">import</span> <span class="n">EC2ResponseError</span>
<span class="kn">from</span> <span class="nn">eutester.euinstance</span> <span class="kn">import</span> <span class="n">EuInstance</span>

<div class="viewcode-block" id="EC2ops"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops">[docs]</a><span class="k">class</span> <span class="nc">EC2ops</span><span class="p">(</span><span class="n">Eutester</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credpath</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">aws_access_key_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">aws_secret_access_key</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span><span class="n">region</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ec2_ip</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">s3_ip</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">boto_debug</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">Eutester</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credpath</span><span class="o">=</span><span class="n">credpath</span><span class="p">,</span> <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">aws_access_key_id</span><span class="p">,</span> <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">aws_secret_access_key</span><span class="p">,</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>  <span class="n">s3_ip</span><span class="o">=</span><span class="n">s3_ip</span><span class="p">,</span> <span class="n">ec2_ip</span><span class="o">=</span><span class="n">ec2_ip</span><span class="p">,</span> <span class="n">boto_debug</span><span class="o">=</span><span class="n">boto_debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poll_count</span> <span class="o">=</span> <span class="mi">48</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_ec2_resource_trackers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_dir</span> <span class="o">=</span> <span class="s">&quot;./&quot;</span>

<div class="viewcode-block" id="EC2ops.setup_ec2_resource_trackers"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.setup_ec2_resource_trackers">[docs]</a>    <span class="k">def</span> <span class="nf">setup_ec2_resource_trackers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup keys in the test_resources hash in order to track artifacts created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span><span class="p">[</span><span class="s">&quot;reservations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span><span class="p">[</span><span class="s">&quot;volumes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span><span class="p">[</span><span class="s">&quot;snapshots&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span><span class="p">[</span><span class="s">&quot;keypairs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span><span class="p">[</span><span class="s">&quot;security-groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span><span class="p">[</span><span class="s">&quot;images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    </div>
<div class="viewcode-block" id="EC2ops.add_keypair"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.add_keypair">[docs]</a>    <span class="k">def</span> <span class="nf">add_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a keypair with name key_name unless it already exists</span>
<span class="sd">        key_name      The name of the keypair to add and download.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">key_name</span> <span class="o">=</span> <span class="s">&quot;keypair-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>  <span class="s">&quot;Looking up keypair &quot;</span> <span class="o">+</span> <span class="n">key_name</span> <span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_key_pairs</span><span class="p">(</span><span class="n">keynames</span><span class="o">=</span><span class="p">[</span><span class="n">key_name</span><span class="p">])</span>    
        <span class="k">except</span> <span class="n">EC2ResponseError</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&#39;Creating keypair: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key_name</span><span class="p">)</span>
            <span class="c"># Create an SSH key to use when logging into instances.</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">create_key_pair</span><span class="p">(</span><span class="n">key_name</span><span class="p">)</span>
            <span class="c"># AWS will store the public key but the private key is</span>
            <span class="c"># generated and returned and needs to be stored locally.</span>
            <span class="c"># The save method will also chmod the file to protect</span>
            <span class="c"># your private key.</span>
            <span class="n">key</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_dir</span><span class="p">)</span>
            <span class="c">#Add the fingerprint header to file</span>
            <span class="n">keyfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_dir</span><span class="o">+</span><span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;.pem&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">keyfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">keyfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">keyfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_dir</span><span class="o">+</span><span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;.pem&#39;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">keyfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;KEYPAIR &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">fingerprint</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">keyfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">keyfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span><span class="p">[</span><span class="s">&quot;keypairs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>  <span class="s">&quot;Key &quot;</span> <span class="o">+</span> <span class="n">key_name</span> <span class="o">+</span> <span class="s">&quot; already exists&quot;</span><span class="p">)</span>
            
            
            </div>
<div class="viewcode-block" id="EC2ops.verify_local_keypath"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.verify_local_keypath">[docs]</a>    <span class="k">def</span> <span class="nf">verify_local_keypath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exten</span><span class="o">=</span><span class="s">&quot;.pem&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to verify if a given ssh key &#39;keyname&#39; exists on the local server at &#39;path&#39;</span>
<span class="sd">        Returns the keypath if the key is found.</span>
<span class="sd">        Example:</span>
<span class="sd">        instance= self.get_instances(state=&#39;running&#39;)[0]</span>
<span class="sd">        keypath = self.get_local_keypath(instance.key_name)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">keypath</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">keyname</span> <span class="o">+</span> <span class="n">exten</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">keypath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Found key at path:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">keypath</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;key:&quot;</span><span class="o">+</span><span class="n">keyname</span><span class="o">+</span><span class="s">&quot;not found at the provided path:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">keypath</span>
    </div>
<div class="viewcode-block" id="EC2ops.get_all_current_local_keys"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_all_current_local_keys">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_current_local_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exten</span><span class="o">=</span><span class="s">&quot;.pem&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to provide a list of all keys in the local dir at &#39;path&#39;</span>
<span class="sd">        that exist on the server. To help avoid producing additional keys in test dev.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keylist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_key_pairs</span><span class="p">()</span>
        <span class="n">keyfile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">keypath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_local_keypath</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">exten</span><span class="p">)</span>
                <span class="n">keyfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">keypath</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">keyfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;KEYPAIR&#39;</span><span class="p">,</span><span class="n">line</span><span class="p">):</span>
                        <span class="n">fingerprint</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">break</span>
                <span class="n">keyfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">fingerprint</span> <span class="o">==</span> <span class="n">k</span><span class="o">.</span><span class="n">fingerprint</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Found key:&#39;</span><span class="o">+</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">keylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">keyfile</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keyfile</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                    <span class="n">keyfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
        <span class="k">return</span> <span class="n">keylist</span>
            
        </div>
<div class="viewcode-block" id="EC2ops.delete_keypair"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.delete_keypair">[docs]</a>    <span class="k">def</span> <span class="nf">delete_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keypair</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the keypair object passed in and check that it no longer shows up</span>
<span class="sd">        keypair      Keypair object to delete and check</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">keypair</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>  <span class="s">&quot;Sending delete for keypair: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">keypair</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">keypair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_key_pairs</span><span class="p">(</span><span class="n">keynames</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">EC2ResponseError</span><span class="p">:</span>
            <span class="n">keypair</span> <span class="o">=</span> <span class="p">[]</span>
            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keypair</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Keypair found after attempt to delete it&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    </div>
<div class="viewcode-block" id="EC2ops.get_windows_instance_password"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_windows_instance_password">[docs]</a>    <span class="k">def</span> <span class="nf">get_windows_instance_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">private_key_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exten</span><span class="o">=</span><span class="s">&quot;.pem&quot;</span><span class="p">,</span> <span class="n">encoded</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_windows_instance_password, instance:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, keypath:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">private_key_path</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, dir:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, exten:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">exten</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, encoded:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">encoded</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">M2Crypto</span> <span class="kn">import</span> <span class="n">RSA</span>
            <span class="kn">import</span> <span class="nn">base64</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&quot;Unable to load M2Crypto. Please install by using your package manager to install &quot;</span>
                              <span class="s">&quot;python-m2crypto or &#39;easy_install M2crypto&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">private_key_path</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">private_key_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_local_keypath</span><span class="p">(</span> <span class="n">key</span><span class="o">.</span><span class="n">name</span> <span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">exten</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">private_key_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;get_windows_instance_password, keypath not found?&#39;</span><span class="p">)</span>        
        <span class="n">encrypted_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_password_data</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">user_priv_key</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">load_key</span><span class="p">(</span><span class="n">private_key_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoded</span><span class="p">:</span>
            <span class="n">string_to_decrypt</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">encrypted_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">string_to_decrypt</span> <span class="o">=</span> <span class="n">encrypted_string</span>
        <span class="k">return</span> <span class="n">user_priv_key</span><span class="o">.</span><span class="n">private_decrypt</span><span class="p">(</span><span class="n">string_to_decrypt</span><span class="p">,</span><span class="n">RSA</span><span class="o">.</span><span class="n">pkcs1_padding</span><span class="p">)</span>   
        
</div>
<div class="viewcode-block" id="EC2ops.add_group"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.add_group">[docs]</a>    <span class="k">def</span> <span class="nf">add_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fail_if_exists</span><span class="o">=</span><span class="bp">False</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a security group to the system with name group_name, if it exists dont create it</span>
<span class="sd">        group_name      Name of the security group to create</span>
<span class="sd">        fail_if_exists  IF set, will fail if group already exists, otherwise will return the existing group</span>
<span class="sd">        returns boto group object upon success or None for failure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="s">&quot;group-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_group</span><span class="p">(</span><span class="n">group_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fail_if_exists</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span>  <span class="s">&quot;Group &quot;</span> <span class="o">+</span> <span class="n">group_name</span> <span class="o">+</span> <span class="s">&quot; already exists&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>  <span class="s">&quot;Group &quot;</span> <span class="o">+</span> <span class="n">group_name</span> <span class="o">+</span> <span class="s">&quot; already exists&quot;</span><span class="p">)</span>
                <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_security_groups</span><span class="p">(</span><span class="n">group_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span><span class="p">[</span><span class="s">&quot;security-groups&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">group</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&#39;Creating Security Group: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">group_name</span><span class="p">)</span>
            <span class="c"># Create a security group to control access to instance via SSH.</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">create_security_group</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="n">group_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">group</span>
    </div>
<div class="viewcode-block" id="EC2ops.delete_group"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.delete_group">[docs]</a>    <span class="k">def</span> <span class="nf">delete_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the group object passed in and check that it no longer shows up</span>
<span class="sd">        group      Group object to delete and check</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Sending delete for group: &quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_group</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Group found after attempt to delete it&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    </div>
<div class="viewcode-block" id="EC2ops.check_group"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.check_group">[docs]</a>    <span class="k">def</span> <span class="nf">check_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a group with group_name exists in the system</span>
<span class="sd">        group_name      Group name to check for existence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Looking up group &quot;</span> <span class="o">+</span> <span class="n">group_name</span> <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_security_groups</span><span class="p">(</span><span class="n">groupnames</span><span class="o">=</span><span class="p">[</span><span class="n">group_name</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">EC2ResponseError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>    
    </div>
<div class="viewcode-block" id="EC2ops.authorize_group_by_name"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.authorize_group_by_name">[docs]</a>    <span class="k">def</span> <span class="nf">authorize_group_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">group_name</span><span class="o">=</span><span class="s">&quot;default&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="n">cidr_ip</span><span class="o">=</span><span class="s">&quot;0.0.0.0/0&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authorize the group with group_name, </span>
<span class="sd">        group_name      Name of the group to authorize, default=&quot;default&quot;</span>
<span class="sd">        port            Port to open, default=22</span>
<span class="sd">        protocol        Protocol to authorize, default=tcp</span>
<span class="sd">        cidr_ip         CIDR subnet to authorize, default=&quot;0.0.0.0/0&quot; everything</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Attempting authorization of &quot;</span> <span class="o">+</span> <span class="n">group_name</span> <span class="o">+</span> <span class="s">&quot; on port &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">protocol</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">authorize_security_group_deprecated</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span><span class="n">ip_protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">from_port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">to_port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">cidr_ip</span><span class="o">=</span><span class="n">cidr_ip</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">ResponseError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s">&#39;InvalidPermission.Duplicate&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&#39;Security Group: </span><span class="si">%s</span><span class="s"> already authorized&#39;</span> <span class="o">%</span> <span class="n">group_name</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
            </div>
<div class="viewcode-block" id="EC2ops.authorize_group"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.authorize_group">[docs]</a>    <span class="k">def</span> <span class="nf">authorize_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">group</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="n">cidr_ip</span><span class="o">=</span><span class="s">&quot;0.0.0.0/0&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authorize the group with group_name, </span>
<span class="sd">        group_name      Name of the group to authorize, default=&quot;default&quot;</span>
<span class="sd">        port            Port to open, default=22</span>
<span class="sd">        protocol        Protocol to authorize, default=tcp</span>
<span class="sd">        cidr_ip         CIDR subnet to authorize, default=&quot;0.0.0.0/0&quot; everything</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorize_group_by_name</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">cidr_ip</span><span class="p">)</span> 
    </div>
<div class="viewcode-block" id="EC2ops.terminate_single_instance"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.terminate_single_instance">[docs]</a>    <span class="k">def</span> <span class="nf">terminate_single_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">300</span> <span class="p">):</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s">&#39;terminated&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="EC2ops.wait_for_instance"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.wait_for_instance">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">instance</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s">&quot;running&quot;</span><span class="p">,</span> <span class="n">poll_count</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">480</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for the instance to enter the state</span>
<span class="sd">        instance      Boto instance object to check the state on</span>
<span class="sd">        state        state that we are looking for</span>
<span class="sd">        poll_count   Number of 10 second poll intervals to wait before failure (for legacy test script support)</span>
<span class="sd">        timeout     Time to wait before failure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">poll_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">poll_count</span><span class="o">*</span><span class="mi">10</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Beginning poll loop for instance &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; to go to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">instance_original_state</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">state</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">### If the instance changes state or goes to the desired state before my poll count is complete</span>
        <span class="k">while</span><span class="p">(</span> <span class="n">elapsed</span> <span class="o">&lt;</span>  <span class="n">timeout</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s">&#39;terminated&#39;</span><span class="p">):</span>
            <span class="c">#poll_count -= 1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Instance(&quot;</span><span class="o">+</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s">&quot;) State(&quot;</span><span class="o">+</span><span class="n">instance</span><span class="o">.</span><span class="n">state</span><span class="o">+</span><span class="s">&quot;), elapsed:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">timeout</span><span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span> <span class="n">start</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">instance_original_state</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Instance(&quot;</span><span class="o">+</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s">&quot;) State(&quot;</span><span class="o">+</span><span class="n">instance</span><span class="o">.</span><span class="n">state</span><span class="o">+</span><span class="s">&quot;) time elapsed (&quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;)&quot;</span><span class="p">)</span>
        <span class="c">#self.debug( &quot;Waited a total o&quot; + str( (self.poll_count - poll_count) * 10 ) + &quot; seconds&quot; )</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; did not enter the &#39;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;&#39; state and was left in &quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; did not enter &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; state after elapsed:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; is now in &#39;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">state</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="EC2ops.wait_for_reservation"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.wait_for_reservation">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_reservation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">reservation</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s">&quot;running&quot;</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">480</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for the an entire reservation to enter the state</span>
<span class="sd">        reservation  Boto reservation object to check the state on</span>
<span class="sd">        state        state that we are looking for</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Beginning poll loop for the &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reservation</span><span class="o">.</span><span class="n">instances</span><span class="p">))</span>   <span class="o">+</span> <span class="s">&quot; found in &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">reservation</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">aggregate_result</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">reservation</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">):</span>
                <span class="n">aggregate_result</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">aggregate_result</span>
    </div>
<div class="viewcode-block" id="EC2ops.create_volume"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.create_volume">[docs]</a>    <span class="k">def</span> <span class="nf">create_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">azone</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">snapshot</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">poll_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">timepergig</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new EBS volume then wait for it to go to available state, size or snapshot is mandatory</span>
<span class="sd">        azone        Availability zone to create the volume in</span>
<span class="sd">        size         Size of the volume to be created</span>
<span class="sd">        snapshot     Snapshot to create the volume from</span>
<span class="sd">        timeout      Time to wait before failing. timeout of 0 results in size of volume * timepergig seconds</span>
<span class="sd">        timepergig   Time to wait per gigabyte size of volume, used when timeout is set to 0 </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Determine the Availability Zone of the instance</span>

        <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c">#if timeout is set to 0, use size to create a reasonable timeout for this volume creation</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">snapshot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="n">timepergig</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">volume_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="n">timepergig</span> <span class="o">*</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Sending create volume request&quot;</span> <span class="p">)</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">create_volume</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">azone</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">)</span>
        <span class="c"># Wait for the volume to be created.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Polling for volume to become available&quot;</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="n">volume</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s">&#39;available&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Volume (&quot;</span><span class="o">+</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s">&quot;) State(&quot;</span><span class="o">+</span><span class="n">volume</span><span class="o">.</span><span class="n">status</span><span class="o">+</span><span class="s">&quot;) sleeping &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">poll_interval</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;s&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">poll_interval</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
            <span class="n">volume</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; in &quot;</span> <span class="o">+</span> <span class="n">volume</span><span class="o">.</span><span class="n">status</span> <span class="o">+</span><span class="s">&quot; state&quot;</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">&#39;failed&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; went to: &quot;</span> <span class="o">+</span> <span class="n">volume</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>  
        <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s">&#39;available&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; never went to available and stayed in &quot;</span> <span class="o">+</span> <span class="n">volume</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Deleting volume that never became available&quot;</span><span class="p">)</span>
            <span class="n">volume</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Done. Waited a total of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; seconds&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span><span class="p">[</span><span class="s">&quot;volumes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">volume</span>
    </div>
<div class="viewcode-block" id="EC2ops.delete_volume"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.delete_volume">[docs]</a>    <span class="k">def</span> <span class="nf">delete_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the EBS volume then check that it no longer exists</span>
<span class="sd">        volume        Volume object to delete</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">delete_volume</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Sent delete for volume: &quot;</span> <span class="o">+</span>  <span class="n">volume</span><span class="o">.</span><span class="n">id</span>  <span class="p">)</span>
        <span class="n">poll_count</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">volume</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span> <span class="n">volume</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s">&quot;deleted&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">poll_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">poll_count</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">volume</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; in &quot;</span> <span class="o">+</span> <span class="n">volume</span><span class="o">.</span><span class="n">status</span> <span class="o">+</span> <span class="s">&quot; sleeping 10s&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">poll_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; left in &quot;</span> <span class="o">+</span>  <span class="n">volume</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    </div>
<div class="viewcode-block" id="EC2ops.delete_all_volumes"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.delete_all_volumes">[docs]</a>    <span class="k">def</span> <span class="nf">delete_all_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes all volumes on the cloud</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_volumes</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_volume</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="EC2ops.attach_volume"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.attach_volume">[docs]</a>    <span class="k">def</span> <span class="nf">attach_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">device_path</span><span class="p">,</span> <span class="n">pause</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attach a volume to an instance</span>
<span class="sd">        instance    instance object to attach volume to</span>
<span class="sd">        volume      volume object to attach</span>
<span class="sd">        device_path device name to request on guest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Sending attach for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; to be attached to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; at requested device  &quot;</span> <span class="o">+</span> <span class="n">device_path</span><span class="p">)</span>
        <span class="n">volume</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">device_path</span> <span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>  
        <span class="n">volume</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">laststatus</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">while</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="n">volume</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">attach_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;attached&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">attach_data</span><span class="o">.</span><span class="n">status</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, Attached: &quot;</span> <span class="o">+</span>  <span class="n">volume</span><span class="o">.</span><span class="n">status</span><span class="o">+</span> <span class="s">&quot; - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">attach_data</span><span class="o">.</span><span class="n">status</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;, elapsed:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">attach_data</span><span class="o">.</span><span class="n">status</span>
                    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                        <span class="n">laststatus</span> <span class="o">=</span> <span class="n">status</span>
                    <span class="k">elif</span> <span class="n">laststatus</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Volume status reverted from &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">laststatus</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; to None, attach failed&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; not &#39;attached&#39;, attach_data.status=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; state:&quot;</span> <span class="o">+</span> <span class="n">volume</span><span class="o">.</span><span class="n">status</span> <span class="o">+</span> <span class="s">&quot; pause:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pause</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; elapsed:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">pause</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; left in &quot;</span> <span class="o">+</span>  <span class="n">volume</span><span class="o">.</span><span class="n">status</span><span class="o">+</span> <span class="s">&quot; - &quot;</span> <span class="o">+</span> <span class="n">status</span> <span class="o">+</span> <span class="s">&quot;, elapsed:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>
      
    </div>
<div class="viewcode-block" id="EC2ops.detach_volume"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.detach_volume">[docs]</a>    <span class="k">def</span> <span class="nf">detach_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">pause</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detach a volume</span>
<span class="sd">        volume   volume to detach</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">volume</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Volume does not exist&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">volume</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Sent detach for volume: &quot;</span> <span class="o">+</span> <span class="n">volume</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&quot; which is currently in state: &quot;</span> <span class="o">+</span> <span class="n">volume</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>  
        <span class="k">while</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="n">volume</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s">&quot;in-use&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; left in &quot;</span> <span class="o">+</span>  <span class="n">volume</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; state:&quot;</span> <span class="o">+</span> <span class="n">volume</span><span class="o">.</span><span class="n">status</span> <span class="o">+</span> <span class="s">&quot; pause:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pause</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; elapsed:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">pause</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; left in &quot;</span> <span class="o">+</span>  <span class="n">volume</span><span class="o">.</span><span class="n">status</span> <span class="o">+</span><span class="s">&quot;, elapsed:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>
    </div>
<div class="viewcode-block" id="EC2ops.get_volume_time_attached"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_volume_time_attached">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume_time_attached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">volume</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Description: Get the seconds elapsed since the volume was attached. </span>
<span class="sd">        </span>
<span class="sd">        :type volume: boto volume object</span>
<span class="sd">        :param volume: The volume used to calculate the elapsed time since attached. </span>
<span class="sd">        </span>
<span class="sd">        :rtype: integer</span>
<span class="sd">        :returns: The number of seconds elapsed since this volume was attached. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Getting time elapsed since volume attached...&quot;</span><span class="p">)</span>
        <span class="n">volume</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">attach_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;get_time_since_vol_attached: Volume &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; not attached&quot;</span><span class="p">)</span>
        <span class="c">#get timestamp from attach_data</span>
        <span class="n">attached_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_datetime_from_resource_string</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">attach_data</span><span class="o">.</span><span class="n">attach_time</span><span class="p">)</span>
        <span class="c">#return the elapsed time in seconds</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">())</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">attached_time</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">())</span>
    
    </div>
<div class="viewcode-block" id="EC2ops.get_instance_time_launched"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_instance_time_launched">[docs]</a>    <span class="k">def</span> <span class="nf">get_instance_time_launched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">instance</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Description: Get the seconds elapsed since the volume was attached. </span>
<span class="sd">        </span>
<span class="sd">        :type volume: boto volume object</span>
<span class="sd">        :param volume: The volume used to calculate the elapsed time since attached. </span>
<span class="sd">        </span>
<span class="sd">        :rtype: integer</span>
<span class="sd">        :returns: The number of seconds elapsed since this volume was attached. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Getting time elapsed since instance &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; launched...&quot;</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="c">#get timestamp from launch data</span>
        <span class="n">launch_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_datetime_from_resource_string</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">launch_time</span><span class="p">)</span>
        <span class="c">#return the elapsed time in seconds</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">())</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">launch_time</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">())</span>
    </div>
<div class="viewcode-block" id="EC2ops.get_datetime_from_resource_string"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_datetime_from_resource_string">[docs]</a>    <span class="k">def</span> <span class="nf">get_datetime_from_resource_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Description: Convert a typical resource timestamp to datetime time_struct. </span>
<span class="sd">        </span>
<span class="sd">        :type timestamp: string</span>
<span class="sd">        :param timestamp: Timestamp held within specific boto resource objects.Example timestamp format: 2012-09-19T21:24:03.864Z</span>
<span class="sd">        </span>
<span class="sd">        :rtype: time_struct</span>
<span class="sd">        :returns: The time_struct representation of the timestamp provided. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;\w+&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">))</span>
        <span class="c">#remove milliseconds from list...</span>
        <span class="n">t</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="c">#create a time_struct out of our list</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="s">&quot;%Y %m </span><span class="si">%d</span><span class="s"> %H %M %S&quot;</span><span class="p">)</span>
        
    </div>
<div class="viewcode-block" id="EC2ops.create_snapshot"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.create_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">create_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_id</span><span class="p">,</span> <span class="n">waitOnProgress</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">poll_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new EBS snapshot from an existing volume then wait for it to go to the created state. By default will poll for poll_count.</span>
<span class="sd">        If waitOnProgress is specified than will wait on &quot;waitOnProgress&quot; overrides # of poll_interval periods, using waitonprogress # of</span>
<span class="sd">        periods of poll_interval length in seconds w/o progress before failing</span>
<span class="sd">        An overall timeout can be given for both methods, by default the timeout is not used.    </span>
<span class="sd">        volume_id        (mandatory string) Volume id of the volume to create snapshot from</span>
<span class="sd">        description      (optional string) string used to describe the snapshot</span>
<span class="sd">        waitOnProgress   (optional integer) # of poll intervals to wait while 0 progress is made before exiting, overrides &quot;poll_count&quot; when used</span>
<span class="sd">        poll_interval    (optional integer) time to sleep between polling snapshot status</span>
<span class="sd">        timeout          (optional integer) over all time to wait before exiting as failure</span>
<span class="sd">        returns snapshot </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">waitOnProgress</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">poll_count</span> <span class="o">=</span> <span class="n">waitOnProgress</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">poll_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poll_count</span>
        <span class="n">last_progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">polls</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">snap_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">create_snapshot</span><span class="p">(</span> <span class="n">volume_id</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Waiting for snapshot (&quot;</span> <span class="o">+</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&quot;) creation to complete&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">poll_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">elapsed</span> <span class="o">&lt;=</span> <span class="n">timeout</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">poll_interval</span><span class="p">)</span>
            <span class="n">polls</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">snapshot</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">&#39;failed&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; failed after Polling(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">polls</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;) ,Waited(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; sec), last reported (status:&quot;</span> <span class="o">+</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">status</span><span class="o">+</span><span class="s">&quot; progress:&quot;</span><span class="o">+</span><span class="n">snapshot</span><span class="o">.</span><span class="n">progress</span><span class="o">+</span><span class="s">&quot;)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">curr_progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">))</span>
            <span class="c">#if progress was made, then reset timer </span>
            <span class="k">if</span> <span class="p">(</span><span class="n">waitOnProgress</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">curr_progress</span> <span class="o">&gt;</span> <span class="n">last_progress</span><span class="p">):</span>
                <span class="n">poll_count</span> <span class="o">=</span> <span class="n">waitOnProgress</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">poll_count</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">snap_start</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Snapshot:&quot;</span><span class="o">+</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s">&quot; Status:&quot;</span><span class="o">+</span><span class="n">snapshot</span><span class="o">.</span><span class="n">status</span><span class="o">+</span><span class="s">&quot; Progress:&quot;</span><span class="o">+</span><span class="n">snapshot</span><span class="o">.</span><span class="n">progress</span><span class="o">+</span><span class="s">&quot; Total Polls:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">polls</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; Polls remaining:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">poll_count</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; Time Elapsed:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span>    
            <span class="k">if</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">&#39;completed&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Snapshot created after &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; seconds. &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">polls</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; X (&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">poll_interval</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; second) polling invervals. Status:&quot;</span><span class="o">+</span><span class="n">snapshot</span><span class="o">.</span><span class="n">status</span><span class="o">+</span><span class="s">&quot;, Progress:&quot;</span><span class="o">+</span><span class="n">snapshot</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span><span class="p">[</span><span class="s">&quot;snapshots&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">snapshot</span>
        <span class="c">#At least one of our timers has been exceeded, fail and exit </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; failed after Polling(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">polls</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;) ,Waited(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; sec), last reported (status:&quot;</span> <span class="o">+</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">status</span><span class="o">+</span><span class="s">&quot; progress:&quot;</span><span class="o">+</span><span class="n">snapshot</span><span class="o">.</span><span class="n">progress</span><span class="o">+</span><span class="s">&quot;)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Deleting snapshot(&quot;</span><span class="o">+</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s">&quot;), never progressed to &#39;created&#39; state&quot;</span><span class="p">)</span>
        <span class="n">snapshot</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">None</span>
        
    </div>
<div class="viewcode-block" id="EC2ops.delete_snapshot"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.delete_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">delete_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">snapshot</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the snapshot object&quot;&quot;&quot;</span>
        <span class="n">snapshot</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Sent snapshot delete request for snapshot: &quot;</span> <span class="o">+</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_snapshots</span><span class="p">(</span><span class="n">snapshot_ids</span><span class="o">=</span><span class="p">[</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; status &quot;</span> <span class="o">+</span>  <span class="n">snapshot</span><span class="o">.</span><span class="n">status</span> <span class="o">+</span> <span class="s">&quot; with &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;% progress. Elapsed:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_snapshots</span><span class="p">(</span><span class="n">snapshot_ids</span><span class="o">=</span><span class="p">[</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; left in&quot;</span> <span class="o">+</span>  <span class="n">snapshot</span><span class="o">.</span><span class="n">status</span> <span class="o">+</span> <span class="s">&quot; with &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;% progress. Elapsed:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">snapshot</span>
    </div>
<div class="viewcode-block" id="EC2ops.register_snapshot"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.register_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">register_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">rdn</span><span class="o">=</span><span class="s">&quot;/dev/sda1&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;bfebs&quot;</span><span class="p">,</span> <span class="n">windows</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bdmdev</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ramdisk</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convience function for passing a snapshot instead of its id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_snapshot_by_id</span><span class="p">(</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">rdn</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">windows</span><span class="p">,</span> <span class="n">bdmdev</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ramdisk</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">dot</span> <span class="p">)</span>
        </div>
<div class="viewcode-block" id="EC2ops.register_snapshot_by_id"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.register_snapshot_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">register_snapshot_by_id</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">snap_id</span><span class="p">,</span> <span class="n">rdn</span><span class="o">=</span><span class="s">&quot;/dev/sda1&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;bfebs&quot;</span><span class="p">,</span> <span class="n">windows</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bdmdev</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ramdisk</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="bp">True</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register an image snapshot</span>
<span class="sd">        snap_id        (mandatory string) snapshot id</span>
<span class="sd">        name           (mandatory string) name of image to be registered</span>
<span class="sd">        description    (optional string) description of image to be registered</span>
<span class="sd">        bdmdev         (optional string) block-device-mapping device for image</span>
<span class="sd">        rdn            (optional string) root-device-name for image</span>
<span class="sd">        dot            (optional boolean) Delete On Terminate boolean</span>
<span class="sd">        windows        (optional boolean) Is windows image boolean</span>
<span class="sd">        kernel         (optional string) kernal (note for windows this name should be &quot;windows&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">bdmdev</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bdmdev</span><span class="o">=</span><span class="n">rdn</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&quot;bfebs_&quot;</span><span class="o">+</span> <span class="n">snap_id</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">windows</span> <span class="ow">is</span> <span class="bp">True</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">kernel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">kernel</span><span class="o">=</span><span class="s">&quot;windows&quot;</span>     
            
        <span class="n">bdmap</span> <span class="o">=</span> <span class="n">BlockDeviceMapping</span><span class="p">()</span>
        <span class="n">block_dev_type</span> <span class="o">=</span> <span class="n">BlockDeviceType</span><span class="p">()</span>
        <span class="n">block_dev_type</span><span class="o">.</span><span class="n">snapshot_id</span> <span class="o">=</span> <span class="n">snap_id</span>
        <span class="n">block_dev_type</span><span class="o">.</span><span class="n">delete_on_termination</span> <span class="o">=</span> <span class="n">dot</span>
        <span class="n">bdmap</span><span class="p">[</span><span class="n">bdmdev</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_dev_type</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Register image with: snap_id:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">snap_id</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, rdn:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">rdn</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, desc:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">description</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, windows:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, bdname:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bdmdev</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, name:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, ramdisk:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ramdisk</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;, kernel:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">kernel</span><span class="p">))</span>
        <span class="n">image_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">register_image</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">kernel_id</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">ramdisk_id</span><span class="o">=</span><span class="n">ramdisk</span><span class="p">,</span> <span class="n">block_device_map</span><span class="o">=</span><span class="n">bdmap</span><span class="p">,</span> <span class="n">root_device_name</span><span class="o">=</span><span class="n">rdn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Image now registered as &quot;</span> <span class="o">+</span> <span class="n">image_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image_id</span>
        </div>
<div class="viewcode-block" id="EC2ops.register_image"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.register_image">[docs]</a>    <span class="k">def</span> <span class="nf">register_image</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">image_location</span><span class="p">,</span> <span class="n">rdn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bdmdev</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ramdisk</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register an image based on the s3 stored manifest location</span>
<span class="sd">        name           (optional string) name of image to be registered</span>
<span class="sd">        description    (optional string) description of image to be registered</span>
<span class="sd">        bdm            (optional block_device_mapping) block-device-mapping object for image</span>
<span class="sd">        rdn            (optional string) root-device-name for image</span>
<span class="sd">        kernel         (optional string) kernal (note for windows this name should be &quot;windows&quot;</span>
<span class="sd">        image_location (optional string) path to s3 stored manifest</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">image_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">register_image</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">kernel_id</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">image_location</span><span class="o">=</span><span class="n">image_location</span><span class="p">,</span> <span class="n">ramdisk_id</span><span class="o">=</span><span class="n">ramdisk</span><span class="p">,</span> <span class="n">block_device_map</span><span class="o">=</span><span class="n">bdmdev</span><span class="p">,</span> <span class="n">root_device_name</span><span class="o">=</span><span class="n">rdn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span><span class="p">[</span><span class="s">&quot;images&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image_id</span>
</div>
<div class="viewcode-block" id="EC2ops.deregister_image"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.deregister_image">[docs]</a>    <span class="k">def</span> <span class="nf">deregister_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deregister an image.</span>
<span class="sd">        :param image: boto image object to deregister</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">deregister_image</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_emi</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s">&quot;deregistered&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Image &quot;</span> <span class="o">+</span> <span class="n">image</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span>  <span class="s">&quot; did not enter deregistered state after deregistration was sent to server&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">deregister_image</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="EC2ops.get_emi"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_emi">[docs]</a>    <span class="k">def</span> <span class="nf">get_emi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emi</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">root_device_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">root_device_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s">&quot;available&quot;</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an emi with name emi, or just grab any emi in the system. Additional &#39;optional&#39; match criteria can be defined.</span>
<span class="sd">        emi              (mandatory) Partial ID of the emi to return, defaults to the &#39;emi-&quot; prefix to grab any</span>
<span class="sd">        root_device_type (optional string)  example: &#39;instance-store&#39; or &#39;ebs&#39;</span>
<span class="sd">        root_device_name (optional string)  example: &#39;/dev/sdb&#39; </span>
<span class="sd">        location         (optional string)  partial on location match example: &#39;centos&#39;</span>
<span class="sd">        state            (optional string)  example: &#39;available&#39;</span>
<span class="sd">        arch             (optional string)  example: &#39;x86_64&#39;</span>
<span class="sd">        owner_id         (optional string) owners numeric id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">emi</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">emi</span> <span class="o">=</span> <span class="s">&quot;mi-&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Looking for image prefix: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">emi</span><span class="p">)</span> <span class="p">)</span>
            
        <span class="n">images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_images</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">emi</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>      
                <span class="k">continue</span>  
            <span class="k">if</span> <span class="p">(</span><span class="n">root_device_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">root_device_type</span> <span class="o">!=</span> <span class="n">root_device_type</span><span class="p">):</span>
                <span class="k">continue</span>            
            <span class="k">if</span> <span class="p">(</span><span class="n">root_device_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">root_device_name</span> <span class="o">!=</span> <span class="n">root_device_name</span><span class="p">):</span>
                <span class="k">continue</span>       
            <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">):</span>
                <span class="k">continue</span>            
            <span class="k">if</span> <span class="p">(</span><span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span> <span class="n">location</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">location</span><span class="p">)):</span>
                <span class="k">continue</span>           
            <span class="k">if</span> <span class="p">(</span><span class="n">arch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">architecture</span> <span class="o">!=</span> <span class="n">arch</span><span class="p">):</span>
                <span class="k">continue</span>                
            <span class="k">if</span> <span class="p">(</span><span class="n">owner_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">!=</span> <span class="n">owner_id</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="k">return</span> <span class="n">image</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Unable to find an EMI&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    </div>
<div class="viewcode-block" id="EC2ops.get_all_allocated_addresses"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_all_allocated_addresses">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_allocated_addresses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">account_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_all_allocated_addresses...&quot;</span><span class="p">)</span>
        <span class="n">account_id</span> <span class="o">=</span> <span class="n">account_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_id</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">account_id</span><span class="p">:</span>
            <span class="n">account_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">account_id</span><span class="p">)</span>
            <span class="n">addrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_addresses</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">addrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">addr</span><span class="o">.</span><span class="n">instance_id</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">account_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">addr</span><span class="o">.</span><span class="n">instance_id</span><span class="p">)):</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
    </div>
<div class="viewcode-block" id="EC2ops.get_available_addresses"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_available_addresses">[docs]</a>    <span class="k">def</span> <span class="nf">get_available_addresses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_available_addresses...&quot;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">addrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_addresses</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">addrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">addr</span><span class="o">.</span><span class="n">instance_id</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;(available|nobody)&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="o">.</span><span class="n">instance_id</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
    
    </div>
<div class="viewcode-block" id="EC2ops.allocate_address"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.allocate_address">[docs]</a>    <span class="k">def</span> <span class="nf">allocate_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allocate an address for the current user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Allocating an address&quot;</span><span class="p">)</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">allocate_address</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Unable to allocate address&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Allocated &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">address</span>
    </div>
<div class="viewcode-block" id="EC2ops.associate_address"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.associate_address">[docs]</a>    <span class="k">def</span> <span class="nf">associate_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">instance</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">75</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Associate an address object with an instance&quot;&quot;&quot;</span>
        <span class="n">ip</span> <span class="o">=</span>  <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="o">.</span><span class="n">public_ip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Attemtping to associate &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; with &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">address</span><span class="o">.</span><span class="n">associate</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Unable to associate address &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; with instance:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>
        
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_addresses</span><span class="p">(</span><span class="n">addresses</span><span class="o">=</span><span class="p">[</span><span class="n">ip</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="c">### Ensure address object holds correct instance value</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">address</span><span class="o">.</span><span class="n">instance_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Address &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; never associated with instance&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Address {0} not attached to {1} but rather {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">),</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">address</span><span class="o">.</span><span class="n">instance_id</span><span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_addresses</span><span class="p">(</span><span class="n">addresses</span><span class="o">=</span><span class="p">[</span><span class="n">ip</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>

        <span class="n">poll_count</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="c">### Ensure instance gets correct address</span>
        <span class="k">while</span> <span class="n">instance</span><span class="o">.</span><span class="n">public_dns_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">address</span><span class="o">.</span><span class="n">public_ip</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Address &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; did not associate with instance after:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; seconds&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Instance {0} has IP {1} attached instead of {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">public_dns_name</span><span class="p">,</span> <span class="n">address</span><span class="o">.</span><span class="n">public_ip</span><span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Associated IP successfully&quot;</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="EC2ops.disassociate_address_from_instance"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.disassociate_address_from_instance">[docs]</a>    <span class="k">def</span> <span class="nf">disassociate_address_from_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">75</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disassociate address from instance and ensure that it no longer holds the IP</span>
<span class="sd">        instance     An instance that has an IP allocated&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;disassociate_address_from_instance: instance.public_dns_name:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">public_dns_name</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; instance:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
        <span class="n">ip</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">public_dns_name</span><span class="p">)</span>
        <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_addresses</span><span class="p">(</span><span class="n">addresses</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">public_dns_name</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        
        
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
      
        <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_addresses</span><span class="p">(</span><span class="n">addresses</span><span class="o">=</span><span class="p">[</span><span class="n">address</span><span class="o">.</span><span class="n">public_ip</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c">### Ensure address object hold correct instance value</span>
        <span class="k">while</span> <span class="n">address</span><span class="o">.</span><span class="n">instance_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="o">.</span><span class="n">instance_id</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Address {0} not attached to &quot;{1}&quot; but rather &quot;{2}&quot; after {3} seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">),</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">address</span><span class="o">.</span><span class="n">instance_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Address &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; never associated with instance after &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; seconds&#39;</span><span class="p">)</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_addresses</span><span class="p">(</span><span class="n">addresses</span><span class="o">=</span><span class="p">[</span><span class="n">address</span><span class="o">.</span><span class="n">public_ip</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
            
        
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Attemtping to disassociate &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; from &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="n">address</span><span class="o">.</span><span class="n">disassociate</span><span class="p">()</span>
        
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c">### Ensure instance gets correct address</span>
        <span class="k">while</span> <span class="n">address</span><span class="o">.</span><span class="n">public_ip</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span> <span class="n">instance</span><span class="o">.</span><span class="n">public_dns_name</span><span class="p">,</span><span class="n">address</span><span class="o">.</span><span class="n">public_ip</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Instance {0} has IP &quot;{1}&quot; still using address &quot;{2}&quot; after {3} seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">public_dns_name</span><span class="p">,</span> <span class="n">address</span><span class="o">.</span><span class="n">public_ip</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">))</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Address &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; never disassociated with instance after &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; seconds&#39;</span><span class="p">)</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Disassociated IP successfully&quot;</span><span class="p">)</span>    
</div>
<div class="viewcode-block" id="EC2ops.release_address"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.release_address">[docs]</a>    <span class="k">def</span> <span class="nf">release_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release all addresses or a particular IP</span>
<span class="sd">        address        Address object to release</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Releasing address: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
            <span class="n">address</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Failed to release the address: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    </div>
<div class="viewcode-block" id="EC2ops.check_device"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.check_device">[docs]</a>    <span class="k">def</span> <span class="nf">check_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Used with instance connections. Checks if a device at a certain path exists&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">found</span><span class="p">(</span><span class="s">&quot;ls -1 &quot;</span> <span class="o">+</span> <span class="n">device_path</span><span class="p">,</span> <span class="n">device_path</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="EC2ops.get_volumes"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_volumes">[docs]</a>    <span class="k">def</span> <span class="nf">get_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_id</span><span class="o">=</span><span class="s">&quot;vol-&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">attached_instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">attached_dev</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">snapid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">zone</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">minsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eof</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of volumes that matches the criteria. Criteria options to be matched:</span>
<span class="sd">        volume_id         (optional string) string present within volume id</span>
<span class="sd">        status            (optional string) examples: &#39;in-use&#39;, &#39;creating&#39;, &#39;available&#39;</span>
<span class="sd">        attached_instance (optional string) instance id example &#39;i-1234abcd&#39;</span>
<span class="sd">        attached_dev      (optional string) example &#39;/dev/sdf&#39;</span>
<span class="sd">        snapid            (optional string) snapshot volume was created from example &#39;snap-1234abcd&#39;</span>
<span class="sd">        zone              (optional string) zone of volume example &#39;PARTI00&#39;</span>
<span class="sd">        minsize           (optional integer) minimum size of volume to be matched</span>
<span class="sd">        maxsize           (optional integer) maximum size of volume to be matched</span>
<span class="sd">        eof               (optional boolean) exception on failure to find volume, else returns empty list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">attached_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">attached_dev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">status</span><span class="o">=</span><span class="s">&#39;in-use&#39;</span>
    
        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_volumes</span><span class="p">()</span>             
        <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">volume_id</span><span class="p">,</span> <span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snapid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">snapshot_id</span> <span class="o">!=</span> <span class="n">snapid</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">zone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">zone</span> <span class="o">!=</span> <span class="n">zone</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">status</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">attach_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">attached_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">volume</span><span class="o">.</span><span class="n">attach_data</span><span class="o">.</span><span class="n">instance_id</span> <span class="o">!=</span> <span class="n">attached_instance</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">attached_dev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">attach_data</span><span class="o">.</span><span class="n">device</span> <span class="o">!=</span> <span class="n">attached_dev</span><span class="p">):</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">minsize</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">maxsize</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">volume</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">maxsize</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">retlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eof</span> <span class="ow">and</span> <span class="n">retlist</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Unable to find matching volume&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">retlist</span>
</div>
<div class="viewcode-block" id="EC2ops.get_volume"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_volume">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_id</span><span class="o">=</span><span class="s">&quot;vol-&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">attached_instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">attached_dev</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">snapid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">zone</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">minsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eof</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a single volume that matches the provided criteria</span>
<span class="sd">        Return first volume that matches the criteria. Criteria options to be matched:</span>
<span class="sd">        volume_id         (optional string) string present within volume id</span>
<span class="sd">        status            (optional string) examples: &#39;in-use&#39;, &#39;creating&#39;, &#39;available&#39;</span>
<span class="sd">        attached_instance (optional string) instance id example &#39;i-1234abcd&#39;</span>
<span class="sd">        attached_dev      (optional string) example &#39;/dev/sdf&#39;</span>
<span class="sd">        snapid            (optional string) snapshot volume was created from example &#39;snap-1234abcd&#39;</span>
<span class="sd">        zone              (optional string) zone of volume example &#39;PARTI00&#39;</span>
<span class="sd">        minsize           (optional integer) minimum size of volume to be matched</span>
<span class="sd">        maxsize           (optional integer) maximum size of volume to be matched</span>
<span class="sd">        eof               (optional boolean) exception on failure to find volume, else returns None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volumes</span><span class="p">(</span><span class="n">volume_id</span><span class="o">=</span><span class="n">volume_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">attached_instance</span><span class="o">=</span><span class="n">attached_instance</span><span class="p">,</span> <span class="n">attached_dev</span><span class="o">=</span><span class="n">attached_dev</span><span class="p">,</span> <span class="n">snapid</span><span class="o">=</span><span class="n">snapid</span><span class="p">,</span> <span class="n">zone</span><span class="o">=</span><span class="n">zone</span><span class="p">,</span> <span class="n">minsize</span><span class="o">=</span><span class="n">minsize</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="n">maxsize</span><span class="p">,</span> <span class="n">eof</span><span class="o">=</span><span class="n">eof</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eof</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">vol</span>
        
            
            </div>
<div class="viewcode-block" id="EC2ops.run_instance"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.run_instance">[docs]</a>    <span class="k">def</span> <span class="nf">run_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">keypair</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s">&quot;default&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">zone</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">private_addressing</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">is_reachable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">480</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run instance/s and wait for them to go to the running state</span>
<span class="sd">        image      Image object to use, default is pick the first emi found in the system</span>
<span class="sd">        keypair    Keypair name to use for the instances, defaults to none</span>
<span class="sd">        group      Security group name to apply to this set of instnaces, defaults to none</span>
<span class="sd">        type       VM type to use for these instances, defaults to m1.small</span>
<span class="sd">        zone       Availability zone to run these instances</span>
<span class="sd">        min        Minimum instnaces to launch, default 1</span>
<span class="sd">        max        Maxiumum instances to launch, default 1</span>
<span class="sd">        private_addressing  Runs an instance with only private IP address</span>
<span class="sd">        is_reachable  Instance can be reached on its public IP (Default=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_images</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">emi</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;emi&quot;</span><span class="p">,</span><span class="n">emi</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">emi</span>      
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">Image</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_emi</span><span class="p">(</span><span class="n">emi</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;emi is None. run_instance could not auto find an emi?&quot;</span><span class="p">)</span>   
        <span class="k">if</span> <span class="n">private_addressing</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">addressing_type</span> <span class="o">=</span> <span class="s">&quot;private&quot;</span>
            <span class="n">is_reachable</span><span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">addressing_type</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#In the case a keypair object was passed instead of the keypair name</span>
        <span class="k">if</span> <span class="n">keypair</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keypair</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="n">keypair</span> <span class="o">=</span> <span class="n">keypair</span><span class="o">.</span><span class="n">name</span>
        
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Attempting to run &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">root_device_type</span><span class="p">)</span>  <span class="o">+</span><span class="s">&quot; image &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; in group &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
        <span class="n">reservation</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">key_name</span><span class="o">=</span><span class="n">keypair</span><span class="p">,</span><span class="n">security_groups</span><span class="o">=</span><span class="p">[</span><span class="n">group</span><span class="p">],</span><span class="n">instance_type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">placement</span><span class="o">=</span><span class="n">zone</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="nb">min</span><span class="p">,</span> <span class="n">max_count</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="n">user_data</span><span class="o">=</span><span class="n">user_data</span><span class="p">,</span> <span class="n">addressing_type</span><span class="o">=</span><span class="n">addressing_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_resources</span><span class="p">[</span><span class="s">&quot;reservations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reservation</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reservation</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reservation</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Reservation:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">reservation</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; returned &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reservation</span><span class="o">.</span><span class="n">instances</span><span class="p">))</span><span class="o">+</span><span class="s">&quot; instances, not within min(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;) and max(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_reservation</span><span class="p">(</span><span class="n">reservation</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;An instance did not enter proper running state in &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">reservation</span><span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Terminatng instances in &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">reservation</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminate_instances</span><span class="p">(</span><span class="n">reservation</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Instances in &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">reservation</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; did not enter proper state&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">reservation</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s">&quot;running&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Instance &quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&quot; now in &quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">state</span>  <span class="o">+</span> <span class="s">&quot; state  in zone: &quot;</span>  <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">placement</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Instance &quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&quot; now in &quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">state</span>  <span class="o">+</span> <span class="s">&quot; state  in zone: &quot;</span>  <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">placement</span> <span class="p">)</span>
        <span class="c">#    </span>
        <span class="c"># check to see if public and private DNS names and IP addresses are the same</span>
        <span class="c">#</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">ip_address</span> <span class="ow">is</span> <span class="n">instance</span><span class="o">.</span><span class="n">private_ip_address</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">public_dns_name</span> <span class="ow">is</span> <span class="n">instance</span><span class="o">.</span><span class="n">private_dns_name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">private_addressing</span> <span class="ow">is</span> <span class="bp">False</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; got Public IP: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">ip_address</span><span class="p">)</span>  <span class="o">+</span> <span class="s">&quot; Private IP: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">private_ip_address</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; Public DNS Name: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">public_dns_name</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; Private DNS Name: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">private_dns_name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Instance &quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s">&quot; has he same public and private IPs of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">ip_address</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; got Public IP: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">ip_address</span><span class="p">)</span>  <span class="o">+</span> <span class="s">&quot; Private IP: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">private_ip_address</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; Public DNS Name: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">public_dns_name</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; Private DNS Name: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">private_dns_name</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_valid_ip</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">terminate_instances</span><span class="p">(</span><span class="n">reservation</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Reservation &quot;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">reservation</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; has been terminated because instance &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; did not receive a valid IP&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_reachable</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">public_dns_name</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
                
        <span class="c">#calculate remaining time to wait for establishing an ssh session/euinstance     </span>
        <span class="n">timeout</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        <span class="c">#if we can establish an SSH session convert the instances to the test class euinstance for access to instance specific test methods</span>
        <span class="k">if</span> <span class="n">is_reachable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Converting &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">reservation</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; into euinstances&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_reservation_to_euinstance</span><span class="p">(</span><span class="n">reservation</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">keyname</span><span class="o">=</span><span class="n">keypair</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reservation</span>
</div>
<div class="viewcode-block" id="EC2ops.wait_for_valid_ip"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.wait_for_valid_ip">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_valid_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">zeros</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">elapsed</span> <span class="o">&lt;=</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zeros</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">public_dns_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                <span class="n">elapsed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Timed out waiting for a valid IP (ie anything other than 0.0.0.0.)&quot;</span><span class="p">)</span>
                
            
</div>
<div class="viewcode-block" id="EC2ops.convert_reservation_to_euinstance"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.convert_reservation_to_euinstance">[docs]</a>    <span class="k">def</span> <span class="nf">convert_reservation_to_euinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reservation</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">keyname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
        <span class="n">euinstance_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">keypair</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">keyname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">keypair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keypair</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">reservation</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keypair</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">username</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">euinstance_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">EuInstance</span><span class="o">.</span><span class="n">make_euinstance_from_instance</span><span class="p">(</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">keypair</span><span class="o">=</span><span class="n">keypair</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span> <span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Unable to create Euinstance from &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="n">euinstance_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">euinstance_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">reservation</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="n">euinstance_list</span>
        <span class="k">return</span> <span class="n">reservation</span>
   </div>
<div class="viewcode-block" id="EC2ops.get_keypair"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_keypair">[docs]</a>    <span class="k">def</span> <span class="nf">get_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_key_pairs</span><span class="p">([</span><span class="n">name</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Keypair: &quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot; not found&quot;</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="EC2ops.get_zones"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_zones">[docs]</a>    <span class="k">def</span> <span class="nf">get_zones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">zone_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_zones</span><span class="p">()</span>
        <span class="n">zone_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zone_objects</span><span class="p">:</span>
            <span class="n">zone_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zone</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zone_names</span>
 </div>
<div class="viewcode-block" id="EC2ops.get_instances"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_instances">[docs]</a>    <span class="k">def</span> <span class="nf">get_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                      <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                      <span class="n">idstring</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                      <span class="n">reservation</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                      <span class="n">rootdevtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                      <span class="n">zone</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">pubip</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">privip</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">ramdisk</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">kernel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">image_id</span><span class="o">=</span><span class="bp">None</span>
                      <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of boto instance objects filtered by the provided search criteria</span>
<span class="sd">        Options: </span>
<span class="sd">        state, idstring , reservation , rootdevtype , zone ,key ,</span>
<span class="sd">        pubip ,privip ,ramdisk ,kernel , image_id</span>
<span class="sd">        </span>
<span class="sd">        example: instance = self.get_instances(state=&#39;running&#39;)[0]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ilist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reservations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_instances</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">reservations</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">reservation</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">reservation</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">id</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">idstring</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">idstring</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">rootdevtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">root_device_type</span> <span class="o">!=</span> <span class="n">rootdevtype</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">placement</span> <span class="o">!=</span> <span class="n">zone</span> <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">key_name</span> <span class="o">!=</span> <span class="n">key</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">pubip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">ip_address</span> <span class="o">!=</span> <span class="n">pubip</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">privip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">private_ip_address</span> <span class="o">!=</span> <span class="n">privip</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ramdisk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">ramdisk</span> <span class="o">!=</span> <span class="n">ramdisk</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">kernel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">kernel</span> <span class="o">!=</span> <span class="n">kernel</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">image_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">image_id</span> <span class="o">!=</span> <span class="n">image_id</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">ilist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ilist</span>
    
    </div>
<div class="viewcode-block" id="EC2ops.get_connectable_euinstances"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_connectable_euinstances">[docs]</a>    <span class="k">def</span> <span class="nf">get_connectable_euinstances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">username</span><span class="o">=</span><span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convenience method returns a list of all running instances, for the current creduser</span>
<span class="sd">        for which there are local keys at &#39;path&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">euinstances</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_current_local_keys</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">keypair</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;looking for instances using keypair:&#39;</span><span class="o">+</span><span class="n">keypair</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">&#39;running&#39;</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="n">keypair</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">instances</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">connect</span><span class="p">:</span>
                                <span class="n">keypair</span><span class="o">=</span><span class="bp">None</span>
                                <span class="n">euinstance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">euinstances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EuInstance</span><span class="o">.</span><span class="n">make_euinstance_from_instance</span><span class="p">(</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span><span class="n">keypair</span><span class="o">=</span><span class="n">keypair</span><span class="p">))</span>
                      
            <span class="k">return</span> <span class="n">euinstances</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Failed to find a pre-existing isntance we can connect to:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">pass</span>
    
    </div>
<div class="viewcode-block" id="EC2ops.get_all_attributes"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.get_all_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>   
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a formatted list of all the key pair values pertaining to the object &#39;obj&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buf</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="nb">list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
            <span class="n">buf</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">item</span><span class="p">])</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="n">buf</span>
</div>
<div class="viewcode-block" id="EC2ops.terminate_instances"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.terminate_instances">[docs]</a>    <span class="k">def</span> <span class="nf">terminate_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reservation</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminate instances in the system</span>
<span class="sd">        reservation        Reservation object to terminate all instances in, default is to terminate all instances</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">### If a reservation is not passed then kill all instances</span>
        <span class="n">aggregate_result</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">reservation</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">reservations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get_all_instances</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">reservations</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Sending terminate for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_reservation</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s">&quot;terminated&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="n">aggregate_result</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c">### Otherwise just kill this reservation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">reservation</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Sending terminate for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="p">)</span>
                    <span class="n">instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_reservation</span><span class="p">(</span><span class="n">reservation</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s">&quot;terminated&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">aggregate_result</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">aggregate_result</span>
    </div>
<div class="viewcode-block" id="EC2ops.stop_instances"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.stop_instances">[docs]</a>    <span class="k">def</span> <span class="nf">stop_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">reservation</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">reservation</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Sending stop for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_reservation</span><span class="p">(</span><span class="n">reservation</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s">&quot;stopped&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    </div>
<div class="viewcode-block" id="EC2ops.start_instances"><a class="viewcode-back" href="../../eucaops.html#eucaops.ec2ops.EC2ops.start_instances">[docs]</a>    <span class="k">def</span> <span class="nf">start_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">reservation</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">reservation</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;Sending start for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_reservation</span><span class="p">(</span><span class="n">reservation</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s">&quot;running&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    </div></div>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2012, Vic Iglesias, Matt Clark, Harold Spencer.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>